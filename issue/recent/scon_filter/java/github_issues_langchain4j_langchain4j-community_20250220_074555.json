[
  {
    "number": 26,
    "title": "DashScope: more clearly and strictly constrain messages ordering to fit the model requirements",
    "created_at": "2024-12-06T03:27:35Z",
    "closed_at": "2024-12-06T12:50:01Z",
    "labels": [
      "enhancement",
      "P3",
      "theme: model"
    ],
    "url": "https://github.com/langchain4j/langchain4j-community/pull/26",
    "body": "## Change\r\nMore clearly and strictly constrain messages ordering to fit the model requirements\r\n\r\n\r\n## General checklist\r\n<!-- Please double-check the following points and mark them like this: [X] -->\r\n- [X] There are no breaking changes\r\n- [X] I have added unit and integration tests for my change\r\n- [X] I have manually run all the unit tests in _all_ modules, and they are all green\r\n",
    "comments_url": "https://api.github.com/repos/langchain4j/langchain4j-community/issues/26/comments",
    "author": "jiangsier-xyz",
    "comments": [
      {
        "user": "Martin7-1",
        "created_at": "2024-12-06T06:09:25Z",
        "body": "@jiangsier-xyz Thank you! Some tests fail in my local env. Could you please check?\r\n\r\nQwenChatModelIT:\r\n\r\n```\r\njava.lang.ClassCastException: class java.util.ArrayList cannot be cast to class java.lang.String (java.util.ArrayList and java.lang.String are in module java.base of loader 'bootstrap')\r\n\r\n\tat com.alibaba.dashscope.common.MessageAdapter.read(MessageAdapter.java:128)\r\n\tat com.alibaba.dashscope.common.MessageAdapter.read(MessageAdapter.java:19)\r\n\tat com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$1.readIntoField(ReflectiveTypeAdapterFactory.java:212)\r\n\tat com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$FieldReflectionAdapter.readField(ReflectiveTypeAdapterFactory.java:433)\r\n\tat com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$Adapter.read(ReflectiveTypeAdapterFactory.java:393)\r\n\tat com.google.gson.internal.bind.TypeAdapterRuntimeTypeWrapper.read(TypeAdapterRuntimeTypeWrapper.java:40)\r\n\tat com.google.gson.internal.bind.CollectionTypeAdapterFactory$Adapter.read(CollectionTypeAdapterFactory.java:82)\r\n\tat com.google.gson.internal.bind.CollectionTypeAdapterFactory$Adapter.read(CollectionTypeAdapterFactory.java:61)\r\n\tat com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$1.readIntoField(ReflectiveTypeAdapterFactory.java:212)\r\n\tat com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$FieldReflectionAdapter.readField(ReflectiveTypeAdapterFactory.java:433)\r\n\tat com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$Adapter.read(ReflectiveTypeAdapterFactory.java:393)\r\n\tat com.google.gson.Gson.fromJson(Gson.java:1227)\r\n\tat com.google.gson.Gson.fromJson(Gson.java:1329)\r\n\tat com.google.gson.Gson.fromJson(Gson.java:1271)\r\n\tat com.alibaba.dashscope.utils.JsonUtils.fromJsonObject(JsonUtils.java:72)\r\n\tat com.alibaba.dashscope.aigc.generation.GenerationResult.fromDashScopeResult(GenerationResult.java:29)\r\n\tat com.alibaba.dashscope.aigc.generation.Generation.call(Generation.java:102)\r\n\tat dev.langchain4j.community.model.dashscope.QwenChatModel.generateByNonMultimodalModel(QwenChatModel.java:167)\r\n\tat dev.langchain4j.community.model.dashscope.QwenChatModel.generate(QwenChatModel.java:122)\r\n\tat dev.langchain4j.community.model.dashscope.QwenChatModelIT.should_call_function_with_no_argument_then_answer(QwenChatModelIT.java:63)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:569)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:179)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.Streams$StreamBuilderImpl.forEachRemaining(Streams.java:411)\r\n\tat java.base/java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:762)\r\n\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.Spliterators$ArraySpliterator.forEachRemaining(Spliterators.java:992)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1625)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1625)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1625)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n```\r\n\r\nQwenChatModelListenerIT:\r\n\r\n```\r\njava.lang.AssertionError: onError() must not be called. Exception: class java.util.ArrayList cannot be cast to class java.lang.String (java.util.ArrayList and java.lang.String are in module java.base of loader 'bootstrap')\r\n\r\n\tat dev.langchain4j.model.chat.ChatModelListenerIT$1.onError(ChatModelListenerIT.java:100)\r\n\tat dev.langchain4j.community.model.dashscope.QwenHelper.lambda$onListenError$30(QwenHelper.java:628)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n\tat dev.langchain4j.community.model.dashscope.QwenHelper.onListenError(QwenHelper.java:626)\r\n\tat dev.langchain4j.community.model.dashscope.QwenChatModel.generateByNonMultimodalModel(QwenChatModel.java:177)\r\n\tat dev.langchain4j.community.model.dashscope.QwenChatModel.generate(QwenChatModel.java:122)\r\n\tat dev.langchain4j.model.chat.ChatModelListenerIT.should_listen_request_and_response(ChatModelListenerIT.java:120)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:569)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n```\r\n\r\nQwenStreamingChatModelIT:\r\n\r\n```\r\njava.lang.RuntimeException: java.util.concurrent.ExecutionException: com.alibaba.dashscope.exception.ApiException: {\"statusCode\":200,\"message\":\"\",\"code\":\"response_error\",\"isJson\":false}; status body:{\"statusCode\":200,\"message\":\"\",\"code\":\"response_error\",\"isJson\":false}\r\n\r\n\tat dev.langchain4j.model.chat.TestStreamingResponseHandler.get(TestStreamingResponseHandler.java:57)\r\n\tat dev.langchain4j.community.model.dashscope.QwenStreamingChatModelIT.should_call_must_be_executed_call_function_with_argument_then_answer(QwenStreamingChatModelIT.java:201)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:569)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:179)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.Streams$StreamBuilderImpl.forEachRemaining(Streams.java:411)\r\n\tat java.base/java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:762)\r\n\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.Spliterators$ArraySpliterator.forEachRemaining(Spliterators.java:992)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1625)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1625)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1625)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\nCaused by: java.util.concurrent.ExecutionException: com.alibaba.dashscope.exception.ApiException: {\"statusCode\":200,\"message\":\"\",\"code\":\"response_error\",\"isJson\":false}; status body:{\"statusCode\":200,\"message\":\"\",\"code\":\"response_error\",\"isJson\":false}\r\n\tat java.base/java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:396)\r\n\tat java.base/java.util.concurrent.CompletableFuture.get(CompletableFuture.java:2096)\r\n\tat dev.langchain4j.model.chat.TestStreamingResponseHandler.get(TestStreamingResponseHandler.java:52)\r\n\t... 53 more\r\nCaused by: com.alibaba.dashscope.exception.ApiException: {\"statusCode\":200,\"message\":\"\",\"code\":\"response_error\",\"isJson\":false}; status body:{\"statusCode\":200,\"message\":\"\",\"code\":\"response_error\",\"isJson\":false}\r\n\tat com.alibaba.dashscope.protocol.okhttp.OkHttpHttpClient$3.onFailure(OkHttpHttpClient.java:469)\r\n\tat okhttp3.internal.sse.RealEventSource.processResponse(RealEventSource.kt:78)\r\n\tat okhttp3.internal.sse.RealEventSource.onResponse(RealEventSource.kt:46)\r\n\tat okhttp3.internal.connection.RealCall$AsyncCall.run(RealCall.kt:519)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\r\n\tat java.base/java.lang.Thread.run(Thread.java:840)\r\n```"
      },
      {
        "user": "jiangsier-xyz",
        "created_at": "2024-12-06T09:02:25Z",
        "body": "> @jiangsier-xyz Thank you! Some tests fail in my local env. Could you please check?\r\n> \r\n> QwenChatModelIT:\r\n> \r\n> ```\r\n> java.lang.ClassCastException: class java.util.ArrayList cannot be cast to class java.lang.String (java.util.ArrayList and java.lang.String are in module java.base of loader 'bootstrap')\r\n> \r\n> \tat com.alibaba.dashscope.common.MessageAdapter.read(MessageAdapter.java:128)\r\n> \tat com.alibaba.dashscope.common.MessageAdapter.read(MessageAdapter.java:19)\r\n> \tat com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$1.readIntoField(ReflectiveTypeAdapterFactory.java:212)\r\n> \tat com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$FieldReflectionAdapter.readField(ReflectiveTypeAdapterFactory.java:433)\r\n> \tat com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$Adapter.read(ReflectiveTypeAdapterFactory.java:393)\r\n> \tat com.google.gson.internal.bind.TypeAdapterRuntimeTypeWrapper.read(TypeAdapterRuntimeTypeWrapper.java:40)\r\n> \tat com.google.gson.internal.bind.CollectionTypeAdapterFactory$Adapter.read(CollectionTypeAdapterFactory.java:82)\r\n> \tat com.google.gson.internal.bind.CollectionTypeAdapterFactory$Adapter.read(CollectionTypeAdapterFactory.java:61)\r\n> \tat com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$1.readIntoField(ReflectiveTypeAdapterFactory.java:212)\r\n> \tat com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$FieldReflectionAdapter.readField(ReflectiveTypeAdapterFactory.java:433)\r\n> \tat com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$Adapter.read(ReflectiveTypeAdapterFactory.java:393)\r\n> \tat com.google.gson.Gson.fromJson(Gson.java:1227)\r\n> \tat com.google.gson.Gson.fromJson(Gson.java:1329)\r\n> \tat com.google.gson.Gson.fromJson(Gson.java:1271)\r\n> \tat com.alibaba.dashscope.utils.JsonUtils.fromJsonObject(JsonUtils.java:72)\r\n> \tat com.alibaba.dashscope.aigc.generation.GenerationResult.fromDashScopeResult(GenerationResult.java:29)\r\n> \tat com.alibaba.dashscope.aigc.generation.Generation.call(Generation.java:102)\r\n> \tat dev.langchain4j.community.model.dashscope.QwenChatModel.generateByNonMultimodalModel(QwenChatModel.java:167)\r\n> \tat dev.langchain4j.community.model.dashscope.QwenChatModel.generate(QwenChatModel.java:122)\r\n> \tat dev.langchain4j.community.model.dashscope.QwenChatModelIT.should_call_function_with_no_argument_then_answer(QwenChatModelIT.java:63)\r\n> \tat java.base/java.lang.reflect.Method.invoke(Method.java:569)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:179)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.Streams$StreamBuilderImpl.forEachRemaining(Streams.java:411)\r\n> \tat java.base/java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:762)\r\n> \tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.Spliterators$ArraySpliterator.forEachRemaining(Spliterators.java:992)\r\n> \tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n> \tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n> \tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n> \tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n> \tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n> \tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1625)\r\n> \tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n> \tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n> \tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n> \tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n> \tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1625)\r\n> \tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n> \tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n> \tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n> \tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n> \tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n> \tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1625)\r\n> \tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n> \tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n> \tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n> \tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n> \tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n> \tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n> ```\r\n> \r\n> QwenChatModelListenerIT:\r\n> \r\n> ```\r\n> java.lang.AssertionError: onError() must not be called. Exception: class java.util.ArrayList cannot be cast to class java.lang.String (java.util.ArrayList and java.lang.String are in module java.base of loader 'bootstrap')\r\n> \r\n> \tat dev.langchain4j.model.chat.ChatModelListenerIT$1.onError(ChatModelListenerIT.java:100)\r\n> \tat dev.langchain4j.community.model.dashscope.QwenHelper.lambda$onListenError$30(QwenHelper.java:628)\r\n> \tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n> \tat dev.langchain4j.community.model.dashscope.QwenHelper.onListenError(QwenHelper.java:626)\r\n> \tat dev.langchain4j.community.model.dashscope.QwenChatModel.generateByNonMultimodalModel(QwenChatModel.java:177)\r\n> \tat dev.langchain4j.community.model.dashscope.QwenChatModel.generate(QwenChatModel.java:122)\r\n> \tat dev.langchain4j.model.chat.ChatModelListenerIT.should_listen_request_and_response(ChatModelListenerIT.java:120)\r\n> \tat java.base/java.lang.reflect.Method.invoke(Method.java:569)\r\n> \tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n> \tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n> ```\r\n> \r\n> QwenStreamingChatModelIT:\r\n> \r\n> ```\r\n> java.lang.RuntimeException: java.util.concurrent.ExecutionException: com.alibaba.dashscope.exception.ApiException: {\"statusCode\":200,\"message\":\"\",\"code\":\"response_error\",\"isJson\":false}; status body:{\"statusCode\":200,\"message\":\"\",\"code\":\"response_error\",\"isJson\":false}\r\n> \r\n> \tat dev.langchain4j.model.chat.TestStreamingResponseHandler.get(TestStreamingResponseHandler.java:57)\r\n> \tat dev.langchain4j.community.model.dashscope.QwenStreamingChatModelIT.should_call_must_be_executed_call_function_with_argument_then_answer(QwenStreamingChatModelIT.java:201)\r\n> \tat java.base/java.lang.reflect.Method.invoke(Method.java:569)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:179)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.Streams$StreamBuilderImpl.forEachRemaining(Streams.java:411)\r\n> \tat java.base/java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:762)\r\n> \tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.Spliterators$ArraySpliterator.forEachRemaining(Spliterators.java:992)\r\n> \tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n> \tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n> \tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n> \tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n> \tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n> \tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1625)\r\n> \tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n> \tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n> \tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n> \tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n> \tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n> \tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1625)\r\n> \tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n> \tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n> \tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n> \tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n> \tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n> \tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1625)\r\n> \tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n> \tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n> \tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n> \tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n> \tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n> \tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n> \tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n> Caused by: java.util.concurrent.ExecutionException: com.alibaba.dashscope.exception.ApiException: {\"statusCode\":200,\"message\":\"\",\"code\":\"response_error\",\"isJson\":false}; status body:{\"statusCode\":200,\"message\":\"\",\"code\":\"response_error\",\"isJson\":false}\r\n> \tat java.base/java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:396)\r\n> \tat java.base/java.util.concurrent.CompletableFuture.get(CompletableFuture.java:2096)\r\n> \tat dev.langchain4j.model.chat.TestStreamingResponseHandler.get(TestStreamingResponseHandler.java:52)\r\n> \t... 53 more\r\n> Caused by: com.alibaba.dashscope.exception.ApiException: {\"statusCode\":200,\"message\":\"\",\"code\":\"response_error\",\"isJson\":false}; status body:{\"statusCode\":200,\"message\":\"\",\"code\":\"response_error\",\"isJson\":false}\r\n> \tat com.alibaba.dashscope.protocol.okhttp.OkHttpHttpClient$3.onFailure(OkHttpHttpClient.java:469)\r\n> \tat okhttp3.internal.sse.RealEventSource.processResponse(RealEventSource.kt:78)\r\n> \tat okhttp3.internal.sse.RealEventSource.onResponse(RealEventSource.kt:46)\r\n> \tat okhttp3.internal.connection.RealCall$AsyncCall.run(RealCall.kt:519)\r\n> \tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\r\n> \tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\r\n> \tat java.base/java.lang.Thread.run(Thread.java:840)\r\n> ```\r\n\r\nThis afternoon, the format of dashscope's response changed when a tool_call occurs. I checked with support and they reported that this was an unexpected change and will be reverted soon.\n\n---\n\n@Martin7-1 It looks like DashScope is reverted. I have all the tests passing locally."
      }
    ],
    "satisfaction_conditions": [
      "Ensures compatibility with DashScope's API response format changes",
      "Handles both standard and tool_call response structures correctly",
      "Maintains backward compatibility with previous API versions"
    ]
  }
]